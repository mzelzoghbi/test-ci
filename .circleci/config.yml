version: 2.1

orbs:
  macos: circleci/macos@2

jobs:
  build-and-test:
    macos:
      xcode: "15.4.0"
    resource_class: macos.m1.medium.gen1
    steps:
      - checkout

      - run:
          name: List available simulators
          command: xcrun simctl list devices available

      - run:
          name: Build app
          command: |
            xcodebuild build \
              -project test.xcodeproj \
              -scheme test \
              -destination 'platform=iOS Simulator,name=iPhone 15' \
              -configuration Debug \
              CODE_SIGNING_ALLOWED=NO

      - run:
          name: Run UI tests
          command: |
            xcodebuild test \
              -project test.xcodeproj \
              -scheme test \
              -destination 'platform=iOS Simulator,name=iPhone 15' \
              -configuration Debug \
              CODE_SIGNING_ALLOWED=NO \
              -resultBundlePath TestResults

      - store_test_results:
          path: TestResults

      - store_artifacts:
          path: TestResults
          destination: test-results

workflows:
  build-test:
    jobs:
      - build-and-test
